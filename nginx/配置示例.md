# 配置

## log_format 访问日志格式
**配置：**
```ini
log_format  main  '$time_iso8601 [$remote_addr] [$status] $request_method $request_uri';
```
**显示：**
```txt
2021-10-15T14:57:18+08:00 [127.0.0.1] [304] GET /favicon.ico
```

## gzip 压缩
**配置：**
```ini
gzip             on;
gzip_min_length  2k;
gzip_comp_level  2;
gzip_types       text/xml text/plain text/css text/javascript application/javascript application/json application/xml  application/x-javascript;
gzip_vary        on;
```

详解：
- `gzip             on;`：开启gzip
- `gzip_min_length  2k;`：最小压缩长度为2kb
- `gzip_comp_level  2;`：压缩等级为2
- `gzip_types       text/xml text/plain text/css text/javascript application/javascript application/json application/xml  application/x-javascript;`：只有这些mine类型才压缩(默认包含text/html)
- `gzip_vary        on;`：使用`Vary: Accept-Encoding`响应头

## location 路径匹配
匹配规则：
- `=`：严格匹配
- `^~`：常规字符串，不检查正则表达式
- `~`：区分大小写匹配
- `~*`：不区分大小写匹配
- `!~`：区分大小写不匹配
- `!~*`：不区分大小写不匹配
- `/`：通用匹配，任何请求都会匹配到
- `@`：定义一个命名的location，使用在内部重定向时，例如error_page,try_files
- 多个location配置的情况下匹配顺序为：`=`->`^~`->文件中顺序的正则匹配->`/`

**配置：**
```ini
location = / {
    #规则A：严格匹配
    #只有 http://localhost/ 才匹配
}
location = /login {
    #规则B：严格匹配
    #只有 http://localhost/login 才匹配
}
location ^~ /static/ {
    #规则C：常规字符串，不检查正则表达式
    #只有前缀是 http://localhost/static/ 才匹配
}
location ~ \.(gif|jpg|png|js|css)$ {
    #规则D：区分大小写匹配
    #只有结尾是.git或.jpg或.png或.js或.css才匹配(区分大小写)
}
location ~* \.png$ {
    #规则E：不区分大小写匹配
    #只有结尾是.png才匹配(不区分大小写)
}
location !~ \.html$ {
    #规则F：区分大小写不匹配
    #只有结尾不是.html才匹配(区分大小写)
}
location !~* \.html$ {
    #规则G：不区分大小写不匹配
    #只有结尾不是.html才匹配(不区分大小写)
}
location / {
    #规则H：通用匹配，任何请求都会匹配到
    #以上规则都没匹配到，才会匹配到这儿
    error_page 404 = @fallback;#跳转到规则I：当出现404时，重定向到@fallback
}
location @fallback {
    #规则I：命名location
    #跳转到此处的会重定向到/50x.html，状态码为200
    rewrite ^(.*)$ /50x.html;
}
```

匹配效果如下：
- 访问 http://localhost/ 将匹配规则A
- 访问 http://localhost/login 将匹配规则B
- 访问 http://localhost/register 则匹配规则H
- 访问 http://localhost/static/a.html 将匹配规则C
- 访问 http://localhost/a.gif 和 http://localhost/b.jpg 将匹配规则D和规则E，但是规则D顺序优先，规则E不起作用，而 http://localhost/static/c.png 则优先匹配到规则C
- 访问 http://localhost/a.PNG 则匹配规则E，而不会匹配规则D，因为规则E不区分大小写。
- 访问 http://localhost/a.html 不会匹配规则F和规则G， http://localhost/a.HTML 不会匹配规则G，因为`!`。规则F和规则G属于排除法，符合匹配规则也不会匹配到。
- 访问 http://localhost/category/id/1111 则最终匹配到规则H，因为以上规则都不匹配，这个时候nginx转发请求给后端应用服务器，比如FastCGI(php)，Tomcat(jsp)，nginx作为反向代理服务器存在。
  - 当请求404时，匹配到规则I。

## rewrite 路径重写


## upstream 负载均衡


## proxy_pass 反向代理
总结：都不加含，都加不含
### 结果含location值
#### proxy_pass是根路径
**■■配置1：都不加含**
```ini
location /api {
    proxy_pass        http://localhost:8080;
    proxy_set_header  X-Real-IP  $remote_addr;
}
```
**配置2(location)：**
```ini
location /api/ {
    proxy_pass        http://localhost:8080;
    proxy_set_header  X-Real-IP  $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/api/index`

#### proxy_pass不是根路径
参考`结果不含location值.proxy_pass不是根路径`，只要把`api`加到`proxy_pass`里就可以了，例如：

**■■配置1(location、proxy_pass)：**
```ini
location /api/ {
    proxy_pass        http://localhost:8080/api/abc/;
    proxy_set_header  X-Real-IP  $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/api/abc/index`

### 结果不含location值
#### proxy_pass是根路径
**■■配置1(location、proxy_pass)：都加不含**
```ini
location /api/ {
    proxy_pass        http://localhost:8080/;
    proxy_set_header  X-Real-IP  $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/index`

~~**配置2(proxy_pass)：**~~
```ini
location /api {
    proxy_pass        http://localhost:8080/;
    proxy_set_header  X-Real-IP  $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080//index`，也就是`http://localhost:8080/index`

#### proxy_pass不是根路径
**■■配置1(location、proxy_pass)：都加不含**
```ini
location /api/ {
    proxy_pass        http://localhost:8080/abc/;
    proxy_set_header  X-Real-IP  $remote_addr;
}
```
**配置2：**
```ini
location /api {
    proxy_pass        http://localhost:8080/abc;
    proxy_set_header  X-Real-IP  $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/abc/index`

**■配置3(location)：**
```ini
location /api/ {
    proxy_pass        http://localhost:8080/abc;
    proxy_set_header  X-Real-IP  $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/abcindex`

~~**配置4(proxy_pass)**：~~
```ini
location /api {
    proxy_pass        http://localhost:8080/abc/;
    proxy_set_header  X-Real-IP  $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/abc//index`，也就是`http://localhost:8080/abc/index`

## php代理
```ini
location ~ \.php$ {
    root           html;
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    include        fastcgi_params;
}
```

## ssl配置
需要在`conf`目录下创建`cert`文件夹，并把证书放入。
```ini
server {
    listen       443 ssl;
    server_name  404z.cn;
    ssl_certificate      cert/404z.cn.pem;
    ssl_certificate_key  cert/404z.cn.key;
    ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;
    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;
    location / {
        root   html;
        index  index.html index.htm;
    }
}
```
80端口跳转到443端口配置：
```ini
server {
    listen 80;
    server_name 404z.cn;
    rewrite ^(.*)$ https://$host$1 permanent;
}
```
