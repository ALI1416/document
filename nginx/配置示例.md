# 配置

## log_format 访问日志格式
**配置：**
```ini
log_format  main  '$time_iso8601 [$remote_addr] [$status] $request_method $request_uri';
```
**显示：**
```txt
2021-10-15T14:57:18+08:00 [127.0.0.1] [304] GET /favicon.ico
```

## gzip 压缩
**配置：**
```ini
gzip             on;
gzip_min_length  2k;
gzip_comp_level  2;
gzip_types       text/xml text/plain text/css text/javascript application/javascript application/json application/xml  application/x-javascript;
gzip_vary        on;
```

详解：
- `gzip             on;`：开启gzip
- `gzip_min_length  2k;`：最小压缩长度为2kb
- `gzip_comp_level  2;`：压缩等级为2
- `gzip_types       text/xml text/plain text/css text/javascript application/javascript application/json application/xml  application/x-javascript;`：只有这些mine类型才压缩(默认包含text/html)
- `gzip_vary        on;`：使用`Vary: Accept-Encoding`响应头

## location 路径匹配
匹配规则：
- `=`：严格匹配
- `^~`：常规字符串，不检查正则表达式
- `~`：区分大小写匹配
- `~*`：不区分大小写匹配
- `!~`：区分大小写不匹配
- `!~*`：不区分大小写不匹配
- `/`：通用匹配，任何请求都会匹配到
- `@`：定义一个命名的location，使用在内部重定向时，例如error_page,try_files
- 多个location配置的情况下匹配顺序为：`=`->`^~`->文件中顺序的正则匹配->`/`

**配置：**
```ini
location = / {
    #规则A：严格匹配
    #只有 http://localhost/ 才匹配
}
location = /login {
    #规则B：严格匹配
    #只有 http://localhost/login 才匹配
}
location ^~ /static/ {
    #规则C：常规字符串，不检查正则表达式
    #只有前缀是 http://localhost/static/ 才匹配
}
location ~ \.(gif|jpg|png|js|css)$ {
    #规则D：区分大小写匹配
    #只有结尾是.git或.jpg或.png或.js或.css才匹配(区分大小写)
}
location ~* \.png$ {
    #规则E：不区分大小写匹配
    #只有结尾是.png才匹配(不区分大小写)
}
location !~ \.html$ {
    #规则F：区分大小写不匹配
    #只有结尾不是.html才匹配(区分大小写)
}
location !~* \.html$ {
    #规则G：不区分大小写不匹配
    #只有结尾不是.html才匹配(不区分大小写)
}
location / {
    #规则H：通用匹配，任何请求都会匹配到
    #以上规则都没匹配到，才会匹配到这儿
    error_page 404 = @fallback;#跳转到规则I：当出现404时，重定向到@fallback
}
location @fallback {
    #规则I：命名location
    #跳转到此处的会重定向到/50x.html，状态码为200
    rewrite ^(.*)$ /50x.html;
}
```

匹配效果如下：
- 访问 http://localhost/ 将匹配规则A
- 访问 http://localhost/login 将匹配规则B
- 访问 http://localhost/register 则匹配规则H
- 访问 http://localhost/static/a.html 将匹配规则C
- 访问 http://localhost/a.gif 和 http://localhost/b.jpg 将匹配规则D和规则E，但是规则D顺序优先，规则E不起作用，而 http://localhost/static/c.png 则优先匹配到规则C
- 访问 http://localhost/a.PNG 则匹配规则E，而不会匹配规则D，因为规则E不区分大小写。
- 访问 http://localhost/a.html 不会匹配规则F和规则G， http://localhost/a.HTML 不会匹配规则G，因为`!`。规则F和规则G属于排除法，符合匹配规则也不会匹配到。
- 访问 http://localhost/category/id/1111 则最终匹配到规则H，因为以上规则都不匹配，这个时候nginx转发请求给后端应用服务器，比如FastCGI(php)，Tomcat(jsp)，nginx作为反向代理服务器存在。
  - 当请求404时，匹配到规则I。

## rewrite 路径重写
### 80端口跳转到443端口
```ini
server {
    listen       80;
    server_name  localhost;
    rewrite  ^(.*)$ https://$host$1 permanent;
}
```
- `^(.*)$`：匹配所有路径
- `https://$host$1`：跳转到https网站，并带着URL
- `$host`：用户访问的网站
- `$1`：正则表达式括号里匹配的内容，即URL
- `permanent`：返回带有301代码的永久重定向

### 重写
```ini
server {
    listen       80;
    server_name  localhost;
    default_type  text/plain;
    location / {
        rewrite /test/(.*) /aa; #访问 http://localhost/test/ 时会匹配到，并重写为 http://localhost/aa/，会被下面匹配到/aa
    }
    location = /aa {
        return        200 "ip address is $remote_addr";
    }
}
```

### 多次重写
```ini
server {
    listen       80;
    server_name  localhost;
    default_type  text/plain;
    location / {
        rewrite ^/test1 /test2; #访问 http://localhost/test1/ 时会匹配到，并重写为 http://localhost/test2/，继续向下执行
        rewrite ^/test2 /test3; #匹配到 http://localhost/test2/ 重写为 http://localhost/test3/，会被下面匹配到/test3
    }
    location = /test2 {
        return        200 "/test2";
    }
    location = /test3 {
        return        200 "/test3";
    }
}
```

### last和break
```ini
server {
    listen       80;
    server_name  localhost;
    default_type  text/plain;
    location / {
        #flag为last，会直接匹配location到/test3，输出"/test3"
        rewrite ^/test1 /test2;
        rewrite ^/test2 /test3 last;
        rewrite ^/test3 /test4;
        #location无法匹配到，才继续向下匹配，输出"/test4"
        #rewrite ^/test1 /test2;
        #rewrite ^/test2 /test5 last;
        #rewrite ^/test5 /test4;
        #flag为break，被重写为/test3后，不再重写为/test4，也不会发起location，继续向下指定，匹配到"/test1"，输出"/test1"
        #rewrite ^/test1 /test2;
        #rewrite ^/test2 /test3 break;
        #rewrite ^/test3 /test4;
    }
    location = /test1 {
        return        200 "/test1";
    }
    location = /test2 {
        return        200 "/test2";
    }
    location = /test3 {
        return        200 "/test3";
    }
    location = /test4 {
        return        200 "/test4";
    }
}
```

### 匹配内容
```ini
server {
    listen       80;
    server_name  localhost;
    default_type  text/plain;
    location / {
        #()里匹配的内容，使用$1-$9可以取到
        rewrite ^/(test1)/(test2)/(test3) /$2/$3; #访问 http://localhost/test1/test2/test3 时，会重写到/test2/test3
    }
    location = /test2/test3 {
        return        200 "/test2/test3";
    }
}
```

### 返回指定字符串
```ini
server {
    listen       80;
    server_name  localhost;
    default_type  text/plain; #要指定默认类型，否则会下载文件
    #break; #在此处不会执行return，因为他属于rewrite指令集，会继续向下执行location匹配
    return        200 "ip address is $remote_addr";
}
```

### 返回指定URL
```ini
server {
    listen       80;
    server_name  localhost;
    return       301 https://www.baidu.com/; #指定301永久重定向，可指定代码(301、302、303、307和308)
    #return       https://www.baidu.com/; #默认302临时重定向
}
```

### 变量
```ini
server {
    listen       80;
    server_name  localhost;
    set          $bd https://www.baidu.com/; #定义变量
    return       301 $bd;
}
```

### 判断
- 变量名：如果变量的值为`空字符串`或`0`，则为false。
- 使用`=`和`!=`运算符将变量与字符串进行比较。
- 使用`~`(区分大小写匹配)和`~*`(不区分大小写匹配)运算符将变量与正则表达式匹配。正则表达式可以包含可供以后在`$1`..`$9`变量中重用的捕获。非运算符`!~`和`!~*`也可用。如果正则表达式包含`}`或`;`字符，则整个表达式应该用单引号或双引号括起来。
- 使用`-f`和`!-f`运算符检查文件是否存在。
- 使用`-d`和`!-d`运算符检查目录是否存在。
- 使用`-e`和`!-e`运算符检查文件、目录或符号链接是否存在。
- 使用`-x`和`!-x`运算符检查可执行文件。

#### true和false
```ini
    server {
        listen       80;
        server_name  localhost;
        set          $v 0;
        if ($v) { #if后和{前必须有空格，判断的值为0或空字符串都为false
            return  301 https://www.baidu.com/; #不会重定向，会继续向下走
        }
    }
```

#### 匹配
```ini
server {
    listen       80;
    server_name  localhost;
    default_type  text/plain;
    if ($request_uri ~ "^/test$") { #当url为test时才执行
        return        200 "ip address is $remote_addr";
    }
}
```

## upstream 负载均衡
**总体配置：**
```ini
#访问日志格式
log_format  main '$time_iso8601 [$remote_addr] [$status] $request_method $request_uri [$upstream_addr]';
#访问日志设置
access_log  logs/access.log main;

#81端口
server {
    access_log   off;
    listen       81;
    server_name  localhost;
    default_type  text/plain;
    return        200 "81";
}
#82端口
server {
    access_log   off;
    listen       82;
    server_name  localhost;
    default_type  text/plain;
    return        200 "82";
}
#83端口
server {
    access_log   off;
    listen       83;
    server_name  localhost;
    default_type  text/plain;
    return        200 "83";
}

#HTTP
server {
    listen       80;
    server_name  localhost;
    default_type  text/plain;
    location /test {
        proxy_pass http://test;
    }
}
```
结果是取自`access.log`文件，使用HttpDdos软件进行测试，软件下载地址[HttpDdosv4.3.3.zip](https://gitee.com/ALI1416/document/raw/master/software/httpddos/HttpDdosv4.3.3.zip)

### 轮询
**配置：**
```ini
upstream test{
    server  127.0.0.1:81;
    server  127.0.0.1:82;
    server  127.0.0.1:83;
}
```
**结果：**
```txt
2021-10-25T11:07:20+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T11:07:20+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
2021-10-25T11:07:20+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:83]
2021-10-25T11:07:20+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T11:07:20+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
2021-10-25T11:07:20+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:83]
```

### 权重轮询
**配置：**
```ini
upstream test{
    server  127.0.0.1:81 weight=2;
    server  127.0.0.1:82 weight=2;
    server  127.0.0.1:83;
}
```
**结果：**
```txt
2021-10-25T13:21:42+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T13:21:42+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
2021-10-25T13:21:42+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T13:21:42+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
2021-10-25T13:21:42+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:83]
2021-10-25T13:21:42+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T13:21:42+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
2021-10-25T13:21:42+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T13:21:42+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
2021-10-25T13:21:42+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:83]
```

### 备用服务器
**配置：**
```ini
upstream test{
    server  127.0.0.1:81;
    server  127.0.0.1:82;
    server  127.0.0.1:83 backup;
}
```
**结果：**  
81、82都正常访问时：
```txt
2021-10-25T13:41:46+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T13:41:46+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
2021-10-25T13:41:46+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T13:41:46+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
```
81、82都不能访问时：
```txt
2021-10-25T13:43:37+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:83]
2021-10-25T13:43:37+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:83]
```

### 禁用服务器
**配置：**
```ini
upstream test{
    server  127.0.0.1:81;
    server  127.0.0.1:82 down;
    server  127.0.0.1:83;
}
```
**结果：**  
```txt
2021-10-25T13:46:51+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T13:46:51+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:83]
2021-10-25T13:46:51+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T13:46:51+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:83]
```

### ip_hash
**配置：**
```ini
upstream test{
    ip_hash;
    server  127.0.0.1:81;
    server  127.0.0.1:82;
    server  127.0.0.1:83;
}
```
**结果：**
```txt
2021-10-25T13:28:01+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:83]
2021-10-25T13:28:02+08:00 [192.168.12.232] [200] GET /test [127.0.0.1:81]
```

### hash
**配置：**
```ini
upstream test{
    hash    $request_uri; 
    server  127.0.0.1:81;
    server  127.0.0.1:82;
    server  127.0.0.1:83;
}
```
**结果：**
```txt
2021-10-25T13:37:45+08:00 [127.0.0.1] [200] GET /test?a=05087 [127.0.0.1:83]
2021-10-25T13:37:45+08:00 [127.0.0.1] [200] GET /test?a=61078 [127.0.0.1:83]
2021-10-25T13:37:45+08:00 [127.0.0.1] [200] GET /test?a=14534 [127.0.0.1:81]
2021-10-25T13:37:45+08:00 [127.0.0.1] [200] GET /test?a=55041 [127.0.0.1:82]
2021-10-25T13:37:45+08:00 [127.0.0.1] [200] GET /test?a=35788 [127.0.0.1:82]
2021-10-25T13:37:45+08:00 [127.0.0.1] [200] GET /test?a=23405 [127.0.0.1:82]
```

### random
**配置：**
```ini
upstream test{
    random;
    server  127.0.0.1:81;
    server  127.0.0.1:82;
    server  127.0.0.1:83;
}
```
**结果：**
```txt
2021-10-25T13:49:16+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
2021-10-25T13:49:16+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:83]
2021-10-25T13:49:16+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
2021-10-25T13:49:16+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T13:49:16+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:81]
2021-10-25T13:49:16+08:00 [127.0.0.1] [200] GET /test [127.0.0.1:82]
```

## proxy_pass 反向代理
总结：都不加含，都加不含
### 结果含location值
#### proxy_pass是根路径
**■■配置1：都不加含**
```ini
location /api {
    proxy_pass        http://localhost:8080;
    proxy_set_header  X-Real-IP $remote_addr;
}
```
**配置2(location)：**
```ini
location /api/ {
    proxy_pass        http://localhost:8080;
    proxy_set_header  X-Real-IP $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/api/index`

#### proxy_pass不是根路径
参考`结果不含location值.proxy_pass不是根路径`，只要把`api`加到`proxy_pass`里就可以了，例如：

**■■配置1(location、proxy_pass)：**
```ini
location /api/ {
    proxy_pass        http://localhost:8080/api/abc/;
    proxy_set_header  X-Real-IP $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/api/abc/index`

### 结果不含location值
#### proxy_pass是根路径
**■■配置1(location、proxy_pass)：都加不含**
```ini
location /api/ {
    proxy_pass        http://localhost:8080/;
    proxy_set_header  X-Real-IP $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/index`

~~**配置2(proxy_pass)：**~~
```ini
location /api {
    proxy_pass        http://localhost:8080/;
    proxy_set_header  X-Real-IP $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080//index`，也就是`http://localhost:8080/index`

#### proxy_pass不是根路径
**■■配置1(location、proxy_pass)：都加不含**
```ini
location /api/ {
    proxy_pass        http://localhost:8080/abc/;
    proxy_set_header  X-Real-IP $remote_addr;
}
```
**配置2：**
```ini
location /api {
    proxy_pass        http://localhost:8080/abc;
    proxy_set_header  X-Real-IP $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/abc/index`

**■配置3(location)：**
```ini
location /api/ {
    proxy_pass        http://localhost:8080/abc;
    proxy_set_header  X-Real-IP $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/abcindex`

~~**配置4(proxy_pass)**：~~
```ini
location /api {
    proxy_pass        http://localhost:8080/abc/;
    proxy_set_header  X-Real-IP $remote_addr;
}
```
访问`http://localhost:8080/api/index`时，实际访问`http://localhost:8080/abc//index`，也就是`http://localhost:8080/abc/index`

## php代理
```ini
location ~ \.php$ {
    root           html;
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include        fastcgi_params;
}
```

## ssl配置
需要在`conf`目录下创建`cert`文件夹，并把证书放入。
```ini
server {
    #监听端口
    listen       443 ssl;
    #服务器名称
    server_name  localhost;
    #证书pem文件(放到conf\cert路径下)
    ssl_certificate      cert/404z.cn.pem;
    #证书key文件(放到conf\cert路径下)
    ssl_certificate_key  cert/404z.cn.key;
    #证书其他配置
    ssl_session_cache          shared:SSL:1m;
    ssl_session_timeout        5m;
    ssl_ciphers                HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;
    #首页跳转
    location / {
        root   html;
        index  index.html index.php;
    }
}
```
80端口跳转到443端口配置：
```ini
server {
    listen       80;
    server_name  404z.cn;
    rewrite  ^(.*)$ https://$host$1 permanent;
}
```
